<?xml version="1.0" encoding="utf-8" ?>
<!--  类别详情界面，展示单个类别的内的图片信息  -->
<ContentPage
    x:Class="PictureHamster.App.Views.CategoryDetailsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:fa="clr-namespace:UraniumUI.Icons.FontAwesome;assembly=UraniumUI.Icons.FontAwesome"
    xmlns:local="clr-namespace:PictureHamster.App.Views"
    xmlns:models="clr-namespace:PictureHamster.Share.Models;assembly=PictureHamster.Share"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
    xmlns:viewModel="clr-namespace:PictureHamster.App.ViewModels"
    Title="CategoryContentPage"
    x:DataType="viewModel:CategoryDetailsPageViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="SectionMargin" TargetType="View">
                <Setter Property="Margin" Value="10" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid Padding="10" RowSpacing="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <!--  Top Header  -->
        <Grid Grid.Row="0">
            <!--  Unselected State Header  -->
            <ContentView x:Name="UnselectedHeader" IsVisible="{Binding HasImageSelected, Converter={StaticResource InvertedBoolConverter}}">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <Button
                        Command="{Binding DisplayInfoCommand}"
                        Style="{StaticResource SectionMargin}"
                        Text="信息" />
                    <Label
                        HorizontalOptions="Center"
                        Text="{Binding TopBarTitle}"
                        VerticalOptions="Center" />
                    <Button
                        Command="{Binding RefreshStateCommand}"
                        Style="{StaticResource SectionMargin}"
                        Text="刷新" />
                </Grid>
            </ContentView>
            <!--  Selected State Header  -->
            <ContentView x:Name="SelectedHeader" IsVisible="{Binding HasImageSelected}">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <Button
                        Command="{Binding DisplayInfoCommand}"
                        Style="{StaticResource SectionMargin}"
                        Text="信息" />
                    <Label
                        HorizontalOptions="Center"
                        Text="{Binding TopBarTitle}"
                        VerticalOptions="Center" />
                    <Button
                        Command="{Binding ReturnToUnselectedStateCommand}"
                        Style="{StaticResource SectionMargin}"
                        Text="返回" />
                </Grid>
            </ContentView>
        </Grid>
        <!--  Middle: Picture Grid  -->
        <CollectionView
            Grid.Row="1"
            ItemsSource="{Binding ImageItems}"
            SelectedItem="{Binding SelectedImageItem}"
            SelectionChanged="OnPictureSelected"
            SelectionMode="Single">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" Span="4" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ImageItem">
                    <Border Margin="5" Shadow="False">
                        <Image Aspect="AspectFill" Source="{Binding Path}">
                            <Image.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding BindingContext.SelectPictureCommand, Source={x:Reference Name=Page}}" CommandParameter="{Binding .}" />
                            </Image.GestureRecognizers>
                        </Image>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        <!--  Bottom: Operation Bar  -->
        <Grid Grid.Row="2">
            <!--  Unselected State Footer  -->
            <ContentView x:Name="UnselectedFooter" IsVisible="{Binding HasImageSelected, Converter={StaticResource InverseBooleanConverter}}">
                <StackLayout Spacing="10">
                    <Label Text="{Binding ImageItems.Count}" />
                    <Button Command="{Binding ExportImagesCommand}" Text="导出" />
                    <Button Command="{Binding ViewExportedDirectoryCommand}" Text="查看导出文件" />
                </StackLayout>
            </ContentView>
            <!--  Selected State Footer  -->
            <ContentView x:Name="SelectedFooter" IsVisible="{Binding HasImageSelected}">
                <StackLayout Spacing="10">
                    <!--  Dropdown for Category  -->
                    <uranium:GridLayout
                        ColumnCount="2"
                        ColumnSpacing="4"
                        RowCount="1">
                        <Label Text="{Binding CategoryNameText}" />
                        <Button Command="{Binding UpdateImageCategoryCommand}" Text="修改类别" />
                    </uranium:GridLayout>
                    <!--  Tags panel  -->
                    <FlexLayout JustifyContent="Start" Wrap="Wrap">
                        <!--  Example tag; assume Tags is a collection for a full implementation  -->
                        <StackLayout Margin="2" Padding="5">
                            <Button
                                Command="{Binding RemoveImageKeywordCommand}"
                                HeightRequest="20"
                                Text="标签A"
                                WidthRequest="20" />
                        </StackLayout>
                    </FlexLayout>
                    <!--  Dropdown with Text Input and "添加关键信息" Button  -->
                    <Grid ColumnDefinitions="*, Auto">
                        <Entry Placeholder="关键信息" Text="{Binding KeywordInputText}" />
                        <Button
                            Grid.Column="1"
                            Command="{Binding AddImageKeywordsCommand}"
                            Text="添加关键信息" />
                    </Grid>
                    <!--  Multi-line Description  -->
                    <Editor
                        AutoSize="TextChanges"
                        Placeholder="详细描述"
                        Text="{Binding ImageDescriptionText}" />
                    <Button Command="{Binding UpdateImageDescriptionCommand}" Text="更新图片描述" />
                </StackLayout>
            </ContentView>
        </Grid>
    </Grid>
</ContentPage>